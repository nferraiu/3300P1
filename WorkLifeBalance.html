<html>
    <head>
        <script src="https://d3js.org/d3.v5.min.js"></script>
    </head>
    <body>
        <svg width="400" height="400" id="visualization3"></svg>
        <div id="legend"></div>
        <script>
            vis3 = d3.select("svg#visualization3");
            d3.csv("BetterLifeIndex.csv").then(function(data) {
                console.log(data);
                life_satisfaction_men = [];
                life_satisfaction_women = [];
                education_men = [];
                education_women = [];
                data.forEach(element => {
                    if (element["Indicator"] == "Life satisfaction" && element["Inequality"] == "Men") {
                        life_satisfaction_men.push(element);
                    } else if (element["Indicator"] == "Life satisfaction" && element["Inequality"] == "Women") {
                        life_satisfaction_women.push(element);
                    }
                    if (element["Indicator"] == "Educational attainment" && element["Inequality"] == "Men") {
                        education_men.push(element);
                    } else if (element["Indicator"] == "Educational attainment" && element["Inequality"] == "Women") {
                        education_women.push(element);
                    } 
                });

                function checkCountries(list1, list2) {
                    list1.forEach(a => {
                        var inBoth = false;
                        list2.forEach(b => {
                            if (a["Country"] == b["Country"]) {
                                inBoth = true;
                            }
                        });
                        if (!inBoth) {
                            list1.pop(a);
                        }
                    });
                }
                if (life_satisfaction_men.length > life_satisfaction_women.length) {
                    checkCountries(life_satisfaction_men, life_satisfaction_women);
                } else {
                    checkCountries(life_satisfaction_women, life_satisfaction_men);
                }
                if (education_men.length > education_women.length) {
                    checkCountries(education_men, education_women);
                } else {
                    checkCountries(education_women, education_men);
                }
                if (education_men.length > life_satisfaction_men) {
                    checkCountries(education_men, life_satisfaction_men);
                    checkCountries(education_women, life_satisfaction_women);
                } else {
                    checkCountries(life_satisfaction_men, education_men);
                    checkCountries(life_satisfaction_women, education_women);
                }

                console.log("life satisfaction men");
                console.log(life_satisfaction_men);
                console.log("life satisfaction women");
                console.log(life_satisfaction_women);
                console.log("ed men");
                console.log(education_men);
                console.log("ed women");
                console.log(education_women);
                
                life_men_extent = d3.extent(life_satisfaction_men, d => d["Value"]);
                life_women_extent = d3.extent(life_satisfaction_women, d => d["Value"]);
                edu_men_extent = d3.extent(education_men, d => d["Value"]);
                edu_women_extent = d3.extent(education_women, d => d["Value"]);

                console.log(life_men_extent);
                console.log(life_women_extent);
                console.log(edu_men_extent);
                console.log(edu_women_extent);

                var life_min; 
                var life_max;
                var edu_min;
                var edu_max;
                if (Number(life_men_extent[0]) < Number(life_women_extent[0])) {
                    life_min = Number(life_men_extent[0]);
                } else {
                    life_min = Number(life_women_extent[0]);
                }
                if (Number(life_men_extent[1]) > Number(life_women_extent[1])) {
                    life_max = Number(life_men_extent[1]);
                } else {
                    life_max = Number(life_women_extent[1]);
                }
                if (Number(edu_men_extent[0]) < Number(edu_women_extent[0])) {
                    edu_min = Number(edu_men_extent[0]);
                } else {
                    edu_min = Number(edu_women_extent[0]);
                }
                if (Number(edu_men_extent[1]) > Number(edu_women_extent[1])) {
                    edu_max = Number(edu_men_extent[1]);
                } else {
                    edu_max = Number(edu_women_extent[1]);
                }

                console.log(life_min);
                console.log(life_max);
                console.log(edu_min);
                console.log(edu_max);

                const x_scale = d3.scaleLinear().domain([edu_min-10, edu_max+10]).range([0,300]);
                const y_scale = d3.scaleLinear().domain([life_min-1, life_max+1]).range([300,0]);

                let left_axis = d3.axisLeft(y_scale);
                let left_grid = d3.axisLeft(y_scale).tickSize(-310).tickFormat("");

                let bottom_axis = d3.axisBottom(x_scale);
                let bottom_grid = d3.axisBottom(x_scale).tickSize(-310).tickFormat("");

                vis3.append("g")
                    .attr("transform","translate(50,50)")
                    .call(left_axis);
                vis3.append("g")
                    .attr("transform","translate(50,50)")
                    .call(left_grid);
                vis3.append("g")
                    .attr("transform","translate(50,350)")
                    .call(bottom_axis);
                vis3.append("g")
                    .attr("transform","translate(50,350)")
                    .call(bottom_grid);

                life_satisfaction_men.forEach(l => {
                    education_men.forEach(e => {
                        if (l["Country"] == e["Country"]) {
                            vis3.append("circle")
                                .attr("id", "men")
                                .attr("cx", x_scale(e["Value"])+50)
                                .attr("cy", y_scale(l["Value"])+50)
                                .attr("r", 5)
                                .attr("fill", "darkgreen")
                                .on("mouseover", function() {
                                    d3.select(this)
                                        .transition().duration(200)
                                        .attr("stroke", "orange")
                                        .attr("stroke-width", 2);
                                    vis3.append("text")
                                        .attr("x", 300)
                                        .attr("y", 30)
                                        .attr("font-size", 14)
                                        .attr("id", "country_label")
                                        .text(e["Country"]);
                                })
                                .on("mouseout", function() {
                                    d3.select(this)
                                        .transition().duration(200)
                                        .attr("stroke", "")
                                        .attr("stroke-width", 0);
                                    d3.select("#country_label").remove();
                                });
                        }
                    });
                });

                life_satisfaction_women.forEach(l => {
                    education_women.forEach(e => {
                        if (l["Country"] == e["Country"]) {
                            vis3.append("circle")
                                .attr("id", "women")
                                .attr("cx", x_scale(e["Value"])+50)
                                .attr("cy", y_scale(l["Value"])+50)
                                .attr("r", 5)
                                .attr("fill", "orange")
                                .on("mouseover", function() {
                                    d3.select(this)
                                        .transition().duration(200)
                                        .attr("stroke", "darkgreen")
                                        .attr("stroke-width", 2);
                                    vis3.append("text")
                                        .attr("x", 300)
                                        .attr("y", 30)
                                        .attr("font-size", 14)
                                        .attr("id", "country_label")
                                        .text(e["Country"]);
                                })
                                .on("mouseout", function() {
                                    d3.select(this)
                                        .transition().duration(200)
                                        .attr("stroke", "")
                                        .attr("stroke-width", 0);
                                    d3.select("#country_label").remove();
                                });
                        }
                    });
                });

                d3.select("#legend")
                    .append("span")
                    .style("color", "darkgreen")
                    .text("Men    ")
                    .on("mouseover", function() {
                            d3.selectAll("#women").each( function () {
                                let cir = d3.select(this);
                                cir.attr("visibility", "hidden");
                            });
                            d3.selectAll("#men").each( function () {
                                let cir = d3.select(this);
                                cir.attr("visibility", "");
                            });
                    });

                d3.select("#legend")
                    .append("span")
                    .style("color", "orange")
                    .text("Women    ")
                    .on("mouseover", function() {
                            d3.selectAll("#men").each( function() {
                                let cir = d3.select(this);
                                cir.attr("visibility", "hidden");
                            });
                            d3.selectAll("#women").each( function() {
                                let cir = d3.select(this);
                                cir.attr("visibility", "");
                            });
                    });

                d3.select("#legend")
                    .append("span")
                    .text("Clear")
                    .on("mouseover", function() {
                        d3.selectAll("#women").each( function() {
                            let cir = d3.select(this);
                            cir.attr("visibility", "");
                        });
                        d3.selectAll("#men").each( function() {
                            let cir = d3.select(this);
                            cir.attr("visibility", "");
                        });
                        
                    });

                vis3.append("text")
                    .attr("transform", "translate(200,385)")
                    .style("text-anchor", "middle")
                    .attr("font-size", 14)
                    .text("Educational Attainment");

                vis3.append("text")
                    .attr("transform", "translate(20,200)rotate(-90)")
                    .style("text-anchor", "middle")
                    .attr("font-size", 14)
                    .text("Life Satisfaction Score");
            });

        </script>

    </body>
</html>